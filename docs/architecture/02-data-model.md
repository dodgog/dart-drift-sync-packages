# Data Model and Schema Design

This document details the data model and schema design used throughout the dart-drift-sync-packages system.

## Core Concepts

### Events

Events are the foundation of the system, representing immutable records of changes that have occurred. Each event:

- Describes a single atomic change
- Is identified by a unique ID
- Has a timestamp for ordering
- Contains information about what changed

### Attributes

Attributes represent the current state of an entity derived from events. The attributes table is essentially a materialized view of entity state after applying all events.

### Bundles

Bundles are groups of events packaged together for synchronization. They provide an efficient way to batch multiple events during client-server communication.

## Schema Definitions

The system uses Drift for type-safe SQL operations in Dart. Schema definitions are divided into several .drift files:

### Shared Schema

Shared schema components are used by both client and server:

```sql
-- shared_bundles.drift
CREATE TABLE bundles (
    id TEXT NOT NULL PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users (id),
    timestamp TEXT NOT NULL,
    payload TEXT
);
```

```sql
-- shared_users.drift
CREATE TABLE users (
    id TEXT NOT NULL PRIMARY KEY,
    name TEXT
);
```

### Client-Specific Schema

```sql
-- events.drift
CREATE TABLE events (
    id TEXT NOT NULL PRIMARY KEY,
    client_id TEXT NOT NULL REFERENCES clients(id),
    entity_id TEXT NOT NULL,
    attribute TEXT NOT NULL,
    value TEXT NOT NULL,
    timestamp TEXT NOT NULL
);
```

```sql
-- attributes.drift
CREATE TABLE attributes (
    entity_id TEXT NOT NULL,
    attribute TEXT,
    value TEXT,
    timestamp TEXT NOT NULL
);

-- With unique index on entity_id+attribute
CREATE UNIQUE INDEX attributes_entity_id_attribute ON attributes(entity_id, attribute);
```

```sql
-- users.drift (client version)
CREATE TABLE clients (
    id TEXT NOT NULL PRIMARY KEY
);

CREATE TABLE config (
    last_server_issued_timestamp TEXT,
    hlc_absolute_zero TEXT NOT NULL
);
```

### Server-Specific Schema

```sql
-- bundles.drift (server version)
-- Additional server-specific bundle operations
```

```sql
-- users.drift (server version)
CREATE TABLE auth (
    user_id TEXT NOT NULL REFERENCES users(id),
    token TEXT NOT NULL
);
```

## Entity Relationships

The relationships between entities in the system:

1. **Users** - Represent end users of the application
   - One user can have multiple clients
   - Users are identified by a unique ID

2. **Clients** - Represent individual devices/applications
   - Each client belongs to one user
   - Clients generate and consume events
   - Each client has a unique ID

3. **Events** - Record atomic changes
   - Generated by a specific client
   - Affect a specific entity and attribute
   - Ordered by timestamp
   - Immutable after creation

4. **Bundles** - Group events for synchronization
   - Created by clients or server
   - Contain event payloads
   - Identified by a UUID
   - Associated with a specific user

5. **Attributes** - Represent current entity state
   - Derived from events
   - Most recent value according to timestamp wins
   - Indexed by entity ID and attribute name

## Data Types and Serialization

The system uses several data types and serialization mechanisms:

1. **UUIDs** - Used for entity IDs, generated using UUIDv7 for time-sortable values

2. **Timestamps** - Hybrid Logical Clock (HLC) timestamps as strings
   - Enable distributed time synchronization
   - Allow for causality tracking across devices

3. **Event Payloads** - JSON-serialized event content
   - Defined in `event_payload_encoder.dart`
   - Automatically generated JSON serialization/deserialization

4. **Query Messages** - JSON-serialized query/response objects
   - Used for client-server communication
   - Include authentication data
   - Auto-generated via json_annotation

## Schema Evolution

The system is designed for schema version control:

- Each database has a schema version
- Migration strategies are defined for upgrading schemas
- The current schema version is 1

## Entity State Derivation

One of the key operations is deriving entity state from events:

1. Events are stored in chronological order
2. The attributes table contains the latest state for each entity attribute
3. When new events arrive, attributes are updated only if the event is newer
4. Conflict resolution is timestamp-based (last-write-wins)

This approach allows for efficient querying of current state while maintaining a complete history of changes.